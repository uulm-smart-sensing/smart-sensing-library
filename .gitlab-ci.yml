image: gitlab.uni-ulm.de:5050/se-anwendungsprojekt-22-23/ci-tools/flutter-devtools:v1.1.0

stages:
  - analysis
  - test

before_script:
  - flutter --version
  - flutter clean
  - bash setup.sh

flutter-analyze:
  stage: analysis
  needs: [ ]
  script:
    - flutter analyze --fatal-infos

flutter-format:
  stage: analysis
  script:
    - flutter format . -o write --fix
    - git diff --exit-code

flutter-format:apply:
  stage: analysis
  needs: [ ]
  when: manual
#  only:
#    - merge_requests
  before_script:
    # FLUTTER_FORMAT_TOKEN is a group access token which is available as a CI variable
    - |
      git remote add ci https://oauth2:${FLUTTER_FORMAT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
      git config user.name "flutter-format bot"
      git config user.email "noreply+flutter-format-bot@${CI_SERVER_HOST}"
      flutter --version
      flutter clean
      bash setup.sh
  script:
    - |
      flutter format . -o write --fix
      git commit -am "style: apply flutter-format"
      git push ci HEAD:$CI_COMMIT_REF_NAME
  after_script:
    - git remote rm ci

flutter-test:
  stage: test
  needs: [ ]
  before_script:
    - flutter --version
    - flutter clean
    - bash setup.sh
    - mkdir -p report_outputs
  script:
    - flutter test --coverage --branch-coverage --coverage-path report_outputs/lcov.info --reporter json --test-randomize-ordering-seed random > report_outputs/test_report.json
  after_script:
    - flutter pub run junitreport:tojunit --input report_outputs/test_report.json --output report_outputs/test_report.xml
    - flutter pub run cobertura convert --input report_outputs/lcov.info --output report_outputs/lcov.xml
    - flutter pub run test_cov_console -f report_outputs/lcov.info -e lib/src/generated
  artifacts:
    paths:
      - report_outputs/test_report.xml
      - report_outputs/lcov.xml
    expire_in: 2 week
    reports:
      junit: report_outputs/test_report.xml
      coverage_report:
        path: report_outputs/lcov.xml
        coverage_format: cobertura
  coverage: '/\|\s*\d+(?:\.\d+)?\s*\|/'
